<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GovFeeds – federal updates on your phone</title>
  <meta name="theme-color" content="#111827" />
  <style>
    :root{
      --bg:#0b1220; --fg:#e5e7eb; --muted:#9ca3af; --card:#111827; --accent:#60a5fa; --danger:#f87171; --ok:#34d399;
      --ring: rgba(96,165,250,.45);
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font:16px system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    a{color:var(--accent);text-decoration:none}
    a:focus,button:focus,input:focus{outline:2px solid var(--ring);outline-offset:2px}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#0b1220 0%,rgba(11,18,32,.92) 70%,rgba(11,18,32,.7) 100%);backdrop-filter:saturate(140%) blur(6px);}    
    .wrap{max-width:900px;margin:0 auto;padding:12px 14px}
    .row{display:flex;align-items:center;gap:10px}
    h1{font-size:20px;margin:6px 0}
    .btn{appearance:none;border:1px solid #2a3446;background:#0f172a;color:var(--fg);padding:10px 12px;border-radius:12px;cursor:pointer}
    .btn.ghost{background:transparent}
    .btn.primary{border-color:#1f2a3d;background:#1f2a3d}
    .btn.full{width:100%}
    .grid{display:grid;gap:12px}
    @media(min-width:720px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    section{margin:14px 0}
    .card{background:var(--card);border:1px solid #1f2a3d;border-radius:16px;padding:14px}
    .title{font-weight:700;margin:0 0 6px}
    .meta{color:var(--muted);font-size:13px;margin-bottom:8px}
    .pill{display:inline-block;border:1px solid #334155;border-radius:999px;padding:2px 8px;font-size:12px;color:#cbd5e1;margin-right:6px}
    .footer{font-size:12px;color:var(--muted);margin-top:8px}
    .section-title{display:flex;align-items:center;justify-content:space-between;margin:14px 2px}
    .section-title h2{font-size:16px;margin:0}
    .empty{color:var(--muted);font-style:italic}
    .badge{font-size:12px;padding:2px 8px;border-radius:999px;background:#0f172a;border:1px solid #334155;color:#cbd5e1}
    .danger{color:var(--danger)}
    .ok{color:var(--ok)}

    /* Settings panel */
    dialog{width:min(720px,92vw);border:1px solid #223049;border-radius:18px;background:#0b1220;color:var(--fg);padding:0}
    dialog::backdrop{background:rgba(0,0,0,.56)}
    .dlg-head{padding:14px;border-bottom:1px solid #1f2a3d;display:flex;justify-content:space-between;align-items:center}
    .dlg-body{padding:14px}
    .field{margin:10px 0}
    label{display:block;margin-bottom:6px;color:#cbd5e1;font-size:14px}
    input[type="text"],input[type="password"],input[type="number"]{width:100%;padding:12px 10px;border-radius:12px;border:1px solid #223049;background:#0f172a;color:var(--fg)}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:12px}

    /* Save button */
    .save-btn{float:right;border-color:#334155;background:#0f172a}
    .save-btn[data-saved="1"]{border-color:#60a5fa}

    /* Small helpers */
    .spinner{width:16px;height:16px;border:2px solid #314160;border-top-color:var(--accent);border-radius:50%;display:inline-block;animation:spin 1s linear infinite;vertical-align:-2px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .sr-only{position:absolute;left:-10000px}
  </style>
</head>
<body>
  <header>
    <div class="wrap row" style="justify-content:space-between">
      <div class="row">
        <h1>GovFeeds</h1>
        <span class="badge" id="statusBadge">offline</span>
      </div>
      <div class="row">
        <button class="btn ghost" id="refreshBtn">Refresh</button>
        <button class="btn ghost" id="diagnoseBtn">Diagnose</button>
        <button class="btn primary" id="openSettings">Settings</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section>
      <div class="section-title">
        <h2>Federal Register – latest</h2>
        <span class="badge" id="frCount">…</span>
      </div>
      <div id="frList" class="grid"></div>
    </section>

    <section>
      <div class="section-title">
        <h2>Regulations.gov — latest</h2>
        <span class="badge" id="regsCount">API key optional</span>
      </div>
      <div id="regsList" class="grid"></div>
    </section>

    <section>
      <div class="section-title">
        <h2>Economy — FRED</h2>
        <span class="badge" id="fredBadge">widget</span>
      </div>
      <div id="fredPanel" class="grid"></div>
    </section>

    <section>
      <div class="section-title">
        <h2>Weather — <span id="placeLabel">locating…</span></h2>
        <span class="badge" id="wxBadge">…</span>
      </div>
      <div id="wxPanel" class="grid"></div>
    </section>

    <section>
      <div class="section-title">
        <h2>Congress.gov – recent bills</h2>
        <span class="badge" id="cgCount">API key optional</span>
      </div>
      <div id="cgList" class="grid"></div>
    </section>

    <section>
      <div class="section-title">
        <h2>Saved</h2>
        <span class="badge" id="savedCount">0</span>
      </div>
      <div id="savedList" class="grid"></div>
    </section>

    <p class="footer">Tip: On iPhone Safari, tap <strong>Share</strong> → <strong>Add to Home Screen</strong> to pin GovFeeds like an app.</p>
  </main>

  <!-- Settings dialog -->
  <dialog id="settings">
    <div class="dlg-head">
      <strong>Settings</strong>
      <button class="btn ghost" id="closeSettings">Close</button>
    </div>
    <form method="dialog" class="dlg-body" id="settingsForm">
      <div class="two">
        <div class="field">
          <label for="state">State (2-letter, e.g., PA)</label>
          <input id="state" name="state" type="text" minlength="2" maxlength="2" pattern="[A-Za-z]{2}" title="Two-letter state code (e.g., PA)" placeholder="PA" />
        </div>
        <div class="field">
          <label for="perPage">Items per feed</label>
          <input id="perPage" name="perPage" type="number" min="1" max="50" value="10" />
        </div>
      </div>
      <div class="field">
        <label><input id="useGeo" type="checkbox" /> Use my location for weather</label>
      </div>
      <div class="field">
        <label for="cgKey">Congress.gov API key (optional)</label>
        <input id="cgKey" name="cgKey" type="password" placeholder="Paste your key" />
      </div>
      <div class="field">
        <label for="regsKey">Regulations.gov API key (api.data.gov)</label>
        <input id="regsKey" name="regsKey" type="password" placeholder="Paste your key" />
      </div>
      <div class="field">
        <label><input id="showFred" type="checkbox" checked/> Show FRED @ a Glance widget</label>
      </div>
      <div class="row" style="justify-content:flex-end;gap:8px;margin-top:6px">
        <button class="btn ghost" type="reset" id="resetBtn">Reset</button>
        <button class="btn primary" type="submit">Save</button>
      </div>
    </form>
  </dialog>

  <!-- Diagnostics dialog -->
  <dialog id="diag">
    <div class="dlg-head">
      <strong>Diagnostics</strong>
      <button class="btn ghost" id="closeDiag">Close</button>
    </div>
    <div class="dlg-body">
      <div id="diagOut" class="grid"></div>
      <div class="footer">This checks connectivity from your device.</div>
    </div>
  </dialog>

  <script>
    const VERSION = '2025-09-11-2';

    const els = {
      frList: document.getElementById('frList'),
      regsList: document.getElementById('regsList'),
      cgList: document.getElementById('cgList'),
      frCount: document.getElementById('frCount'),
      regsCount: document.getElementById('regsCount'),
      cgCount: document.getElementById('cgCount'),
      savedList: document.getElementById('savedList'),
      savedCount: document.getElementById('savedCount'),
      statusBadge: document.getElementById('statusBadge'),
      refreshBtn: document.getElementById('refreshBtn'),
      openSettings: document.getElementById('openSettings'),
      closeSettings: document.getElementById('closeSettings'),
      dlg: document.getElementById('settings'),
      form: document.getElementById('settingsForm'),
      fieldState: document.getElementById('state'),
      fieldPerPage: document.getElementById('perPage'),
      fieldCgKey: document.getElementById('cgKey'),
      fieldUseGeo: document.getElementById('useGeo'),
      resetBtn: document.getElementById('resetBtn'),
      diagnoseBtn: document.getElementById('diagnoseBtn'),
      diag: document.getElementById('diag'),
      closeDiag: document.getElementById('closeDiag'),
      diagOut: document.getElementById('diagOut'),
      // Weather
      placeLabel: document.getElementById('placeLabel'),
      wxBadge: document.getElementById('wxBadge'),
      wxPanel: document.getElementById('wxPanel'),
      fredBadge: document.getElementById('fredBadge'),
      fredPanel: document.getElementById('fredPanel'),
    };

    // Normalize state codes (returns 'PA' or null). Accepts 'pa', 'PA', or 'US-PA'.
    function normalizeState(s){
      const x = (s || '').trim().toUpperCase();
      if (/^[A-Z]{2}$/.test(x)) return x;
      const m = x.match(/^US-([A-Z]{2})$/);
      return m ? m[1] : null;
    }

    // Approximate coordinates for US state capitals (+ DC)
    const STATE_CAPITALS = {
      AL:{name:'Montgomery, AL',lat:32.377716,lon:-86.300568}, AK:{name:'Juneau, AK',lat:58.301598,lon:-134.420212},
      AZ:{name:'Phoenix, AZ',lat:33.448376,lon:-112.074036}, AR:{name:'Little Rock, AR',lat:34.746613,lon:-92.288986},
      CA:{name:'Sacramento, CA',lat:38.576668,lon:-121.4944}, CO:{name:'Denver, CO',lat:39.739227,lon:-104.984856},
      CT:{name:'Hartford, CT',lat:41.764046,lon:-72.682198}, DE:{name:'Dover, DE',lat:39.157307,lon:-75.519722},
      FL:{name:'Tallahassee, FL',lat:30.438118,lon:-84.281296}, GA:{name:'Atlanta, GA',lat:33.749027,lon:-84.387985},
      HI:{name:'Honolulu, HI',lat:21.307442,lon:-157.857376}, ID:{name:'Boise, ID',lat:43.617775,lon:-116.199722},
      IL:{name:'Springfield, IL',lat:39.798363,lon:-89.654961}, IN:{name:'Indianapolis, IN',lat:39.768623,lon:-86.162643},
      IA:{name:'Des Moines, IA',lat:41.591087,lon:-93.603729}, KS:{name:'Topeka, KS',lat:39.048191,lon:-95.677956},
      KY:{name:'Frankfort, KY',lat:38.186722,lon:-84.875374}, LA:{name:'Baton Rouge, LA',lat:30.457069,lon:-91.187393},
      ME:{name:'Augusta, ME',lat:44.307167,lon:-69.781693}, MD:{name:'Annapolis, MD',lat:38.978764,lon:-76.490936},
      MA:{name:'Boston, MA',lat:42.358162,lon:-71.063698}, MI:{name:'Lansing, MI',lat:42.733635,lon:-84.555328},
      MN:{name:'Saint Paul, MN',lat:44.955097,lon:-93.102211}, MS:{name:'Jackson, MS',lat:32.303848,lon:-90.182106},
      MO:{name:'Jefferson City, MO',lat:38.579201,lon:-92.172935}, MT:{name:'Helena, MT',lat:46.585709,lon:-112.018417},
      NE:{name:'Lincoln, NE',lat:40.808075,lon:-96.699654}, NV:{name:'Carson City, NV',lat:39.163914,lon:-119.766121},
      NH:{name:'Concord, NH',lat:43.206898,lon:-71.537994}, NJ:{name:'Trenton, NJ',lat:40.220596,lon:-74.769913},
      NM:{name:'Santa Fe, NM',lat:35.68224,lon:-105.939728}, NY:{name:'Albany, NY',lat:42.652843,lon:-73.757874},
      NC:{name:'Raleigh, NC',lat:35.78043,lon:-78.639099}, ND:{name:'Bismarck, ND',lat:46.82085,lon:-100.783318},
      OH:{name:'Columbus, OH',lat:39.961346,lon:-82.999069}, OK:{name:'Oklahoma City, OK',lat:35.492207,lon:-97.503342},
      OR:{name:'Salem, OR',lat:44.938461,lon:-123.030403}, PA:{name:'Harrisburg, PA',lat:40.273191,lon:-76.886701},
      RI:{name:'Providence, RI',lat:41.830914,lon:-71.414963}, SC:{name:'Columbia, SC',lat:34.00071,lon:-81.034814},
      SD:{name:'Pierre, SD',lat:44.367031,lon:-100.346405}, TN:{name:'Nashville, TN',lat:36.162663,lon:-86.781601},
      TX:{name:'Austin, TX',lat:30.27467,lon:-97.740349}, UT:{name:'Salt Lake City, UT',lat:40.759619,lon:-111.886797},
      VT:{name:'Montpelier, VT',lat:44.260059,lon:-72.575386}, VA:{name:'Richmond, VA',lat:37.538857,lon:-77.43364},
      WA:{name:'Olympia, WA',lat:47.037872,lon:-122.900696}, WV:{name:'Charleston, WV',lat:38.336246,lon:-81.612328},
      WI:{name:'Madison, WI',lat:43.074684,lon:-89.384445}, WY:{name:'Cheyenne, WY',lat:41.140259,lon:-104.820236},
      DC:{name:'Washington, DC',lat:38.9072,lon:-77.0369}
    };

    const store = {
      get(){
        const raw = localStorage.getItem('govfeeds');
        const def = { state: 'PA', perPage: 10, cgKey: '', regsKey: '', useGeo: false, showFred: true };
        try { return raw ? { ...def, ...JSON.parse(raw) } : def; } catch { return def; }
      },
      set(v){ localStorage.setItem('govfeeds', JSON.stringify(v)); }
    };

    // Saved items store
    const saved = {
      key: 'govfeeds_saved',
      all(){ try { return JSON.parse(localStorage.getItem(this.key)) || []; } catch { return []; } },
      set(list){ localStorage.setItem(this.key, JSON.stringify(list)); },
      is(id){ return this.all().some(x => x.id === id); },
      toggle(item){
        const list = this.all();
        const i = list.findIndex(x => x.id === item.id);
        if(i > -1){ list.splice(i,1); } else { list.unshift(item); }
        this.set(list);
        renderSaved();
      }
    };
    function renderSaved(){
      const list = saved.all();
      els.savedCount.textContent = list.length;
      els.savedList.innerHTML = list.length ? list.map(x => card({
        title: x.title, meta: x.meta, url: x.url, pills: [x.source || 'saved'], id: x.id, source: x.source, isSavedOverride: true
      })).join('') : '<div class="card empty">Nothing saved yet. Tap ★ Save on any item.</div>';
    }

    function setStatus(){
      const online = navigator.onLine;
      if(!online){
        els.statusBadge.textContent = 'offline';
        els.statusBadge.style.color = 'var(--danger)';
        return;
      }
      els.statusBadge.textContent = 'checking…';
      els.statusBadge.style.color = 'var(--accent)';
      probeConnectivity();
    }
    async function probeConnectivity(){
      try{
        const r = await fetch('https://www.federalregister.gov/api/v1/documents.json?per_page=1&order=newest', {cache:'no-store'});
        if(r.ok){
          els.statusBadge.textContent = 'online';
          els.statusBadge.style.color = 'var(--ok)';
        } else {
          els.statusBadge.textContent = 'limited';
          els.statusBadge.style.color = 'var(--danger)';
        }
      }catch{
        els.statusBadge.textContent = 'limited';
        els.statusBadge.style.color = 'var(--danger)';
      }
    }

    window.addEventListener('online', setStatus);
    window.addEventListener('offline', setStatus);
    setStatus();

    function timeAgo(dateStr){
      const d = new Date(dateStr);
      const diff = (Date.now() - d.getTime())/1000;
      const rtf = new Intl.RelativeTimeFormat(undefined,{numeric:'auto'});
      const table = [[60,'second'],[60,'minute'],[24,'hour'],[7,'day'],[4.345,'week'],[12,'month'],[Number.POSITIVE_INFINITY,'year']];
      let unit = 'second', val = -Math.round(diff);
      let t = diff;
      for(const [f,u] of table){ if(t < f){ unit = u; val = -Math.round(t); break;} t = t / f; }
      return rtf.format(val, unit);
    }

    function card({title, meta, url, pills=[], id, source, isSavedOverride=false}){
      const _id = id || url;
      const inferredSource = source || (url?.includes('federalregister.gov') ? 'FR' : url?.includes('weather.gov') ? 'NWS' : url?.includes('congress.gov') ? 'CONGRESS' : 'feed');
      const isSaved = isSavedOverride || (_id ? savedStoreCheck(_id) : false);
      const pillsHtml = pills.map(p=>`<span class="pill">${p}</span>`).join('');
      return `<article class="card">
        <button class="btn save-btn" data-save="1" data-id="${_id}" data-title="${(title||'').replace(/"/g,'&quot;')}" data-url="${url}" data-source="${inferredSource}" data-meta="${(meta||'').replace(/"/g,'&quot;')}" data-saved="${isSaved?1:0}">${isSaved ? '★ Saved' : '☆ Save'}</button>
        <h3 class="title"><a href="${url}" target="_blank" rel="noopener">${title}</a></h3>
        ${meta ? `<div class="meta">${meta}</div>`: ''}
        ${pillsHtml}
      </article>`;
    }
    function savedStoreCheck(id){ return saved.is(id); }

    async function loadFederalRegister(perPage){
      els.frList.innerHTML = `<div class="card"><span class="spinner"></span> Loading Federal Register…</div>`;
      try{
        const url = new URL('https://www.federalregister.gov/api/v1/documents.json');
        url.searchParams.set('per_page', perPage);
        url.searchParams.set('order','newest');
        const res = await fetch(url);
        if(!res.ok) throw new Error('FR HTTP '+res.status);
        const data = await res.json();
        els.frCount.textContent = data.count ? `${Math.min(perPage, data.count)} of ${data.count}` : `${data.results?.length||0}`;
        const items = (data.results||[]).map(doc=>{
          const title = doc.title || 'Untitled';
          const url = doc.html_url || doc.pdf_url || '#';
          const meta = `${doc.agencies?.map(a=>a.name).join(', ')||'Agency'} · ${doc.publication_date} · ${timeAgo(doc.publication_date)}`;
          const pills = [doc.type||'document'];
          const id = doc.document_number ? `FR:${doc.document_number}` : url;
          return card({title, meta, url, pills, id, source:'FR'});
        }).join('');
        els.frList.innerHTML = items || `<div class="card empty">No documents.</div>`;
      }catch(err){
        els.frList.innerHTML = `<div class="card danger">Federal Register error: ${err.message}</div>`;
        els.frCount.textContent = 'error';
      }
    }

    // ---------- Regulations.gov ----------
    async function loadRegs(perPage, key){
      els.regsList.innerHTML = `<div class="card"><span class="spinner"></span> Loading Regulations.gov…</div>`;
      if(!key){ els.regsList.innerHTML = `<div class="card empty">Add a Regulations.gov API key (api.data.gov) in Settings to see latest documents.</div>`; els.regsCount.textContent = 'no key'; return; }
      try{
        const url = new URL('https://api.regulations.gov/v4/documents');
        url.searchParams.set('sort','-postedDate');
        url.searchParams.set('page[size]', perPage);
        url.searchParams.set('api_key', key);
        const res = await fetch(url, { cache:'no-store' });
        if(!res.ok){
          let detail=''; try{ const j = await res.json(); detail = j?.errors?.[0]?.detail || j?.detail || ''; }catch{}
          throw new Error(`HTTP ${res.status}${detail? ' – '+detail : ''}`);
        }
        const json = await res.json();
        const rows = (json.data||[]).map(d=>{
          const a = d.attributes || {};
          const title = a.title || a.documentName || 'Document';
          const agency = a.agency || a.agencyAcronym || (a.agencies && a.agencies[0]?.name) || 'Agency';
          const posted = a.postedDate || a.lastModifiedDate || a.lastModified;
          const docketId = a.docketId || (a.docketIds && a.docketIds[0]) || '';
          const docType = a.documentType || a.type || 'doc';
          const url = `https://www.regulations.gov/document/${encodeURIComponent(d.id||a.documentId||'')}`;
          const pills = [docType, docketId].filter(Boolean);
          const meta = `${agency}${posted?` · ${posted} (${timeAgo(posted)})`:''}`;
          const id = `REGS:${d.id||title}`;
          return card({title, meta, url, pills, id, source:'REGS'});
        }).join('');
        els.regsList.innerHTML = rows || `<div class="card empty">No recent documents.</div>`;
        els.regsCount.textContent = (json.data||[]).length || '0';
      }catch(err){
        els.regsList.innerHTML = `<div class="card danger">Regulations.gov error: ${err.message}</div>`;
        els.regsCount.textContent = 'error';
      }
    }

    // ---------- Weather (NWS) ----------
    async function getPreferredCoords(){
      const cfg = store.get();
      if(cfg.useGeo && 'geolocation' in navigator){
        try{
          const pos = await new Promise((resolve,reject)=> navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy:true, timeout:8000, maximumAge:300000 }));
          const { latitude:lat, longitude:lon } = pos.coords;
          localStorage.setItem('govfeeds_lastGeo', JSON.stringify({lat,lon,t:Date.now()}));
          return { lat, lon, name: 'Your location' };
        }catch(e){ /* fallthrough to state capital */ }
      }
      const st = normalizeState(store.get().state || 'PA') || 'PA';
      const cap = STATE_CAPITALS[st];
      if(cap) return { lat: cap.lat, lon: cap.lon, name: cap.name };
      return { lat: 38.9072, lon: -77.0369, name: 'Washington, DC' };
    }

    async function loadWeather(){
      els.wxPanel.innerHTML = `<div class="card"><span class="spinner"></span> Loading weather…</div>`;
      els.placeLabel.textContent = 'locating…';
      try{
        const loc = await getPreferredCoords();
        els.placeLabel.textContent = loc.name;
        // Discover forecast URL from points
        const pRes = await fetch(`https://api.weather.gov/points/${loc.lat},${loc.lon}`, { cache:'no-store' });
        if(!pRes.ok) throw new Error('Points HTTP '+pRes.status);
        const pJson = await pRes.json();
        const forecastUrl = pJson?.properties?.forecast;
        const rel = pJson?.properties?.relativeLocation?.properties;
        if(rel?.city && rel?.state){ els.placeLabel.textContent = `${rel.city}, ${rel.state}`; }
        if(!forecastUrl) throw new Error('No forecast URL');
        const fRes = await fetch(forecastUrl, { cache:'no-store' });
        if(!fRes.ok) throw new Error('Forecast HTTP '+fRes.status);
        const fJson = await fRes.json();
        const periods = fJson?.properties?.periods || [];
        if(periods.length === 0) throw new Error('No forecast periods');

        // Determine today high/low from first two periods
        const p0 = periods[0];
        const p1 = periods[1] || null;
        let high = null, low = null, highLabel = '', lowLabel = '';
        if(p0.isDaytime){ high = p0.temperature; highLabel = p0.name; if(p1){ low = p1.temperature; lowLabel = p1.name; } }
        else { low = p0.temperature; lowLabel = p0.name; if(p1){ high = p1.temperature; highLabel = p1.name; } }

        // Build small dashboard
        const cards = [];
        if(high !== null) cards.push(`<article class="card"><h3 class="title">High</h3><div class="meta">${highLabel}</div><div style="font-size:28px;font-weight:700">${high}°F</div></article>`);
        if(low !== null) cards.push(`<article class="card"><h3 class="title">Low</h3><div class="meta">${lowLabel}</div><div style="font-size:28px;font-weight:700">${low}°F</div></article>`);
        const now = p0;
        cards.push(`<article class="card"><h3 class="title">Forecast</h3><div class="meta">${now.name}</div><div>${now.shortForecast||'—'}</div><div class="meta">Wind: ${now.windDirection||''} ${now.windSpeed||''}</div></article>`);
        cards.push(`<article class="card"><h3 class="title">Full forecast</h3><div><a href="${forecastUrl}" target="_blank" rel="noopener">Open at weather.gov</a></div></article>`);
        els.wxPanel.innerHTML = cards.join('');
        els.wxBadge.textContent = `${high!==null?('H '+high+'°'):''}${(high!==null&&low!==null)?' / ':''}${low!==null?('L '+low+'°'):''}` || '—';
      }catch(err){
        els.wxPanel.innerHTML = `<div class="card danger">Weather error: ${err.message}</div>`;
        els.wxBadge.textContent = 'error';
      }
    }

    async function loadFRED(show){
      if(!show){ els.fredPanel.innerHTML = `<div class="card empty">FRED widget disabled in Settings.</div>`; els.fredBadge.textContent = 'off'; return; }
      els.fredPanel.innerHTML = `<article class="card"><iframe title="FRED @ A Glance" style="width:100%;height:520px;border:0;overflow:hidden" src="https://research.stlouisfed.org/fred-glance-widget.php" loading="lazy" referrerpolicy="no-referrer"></iframe></article>`;
      els.fredBadge.textContent = 'widget';
    }

    async function loadCongress(perPage, key){
      els.cgList.innerHTML = `<div class="card"><span class="spinner"></span> Loading Congress.gov…</div>`;
      if(!key){ els.cgList.innerHTML = `<div class="card empty">Add a Congress.gov API key in Settings to see recent bills.</div>`; els.cgCount.textContent = 'no key'; return; }
      try{
        const url = new URL('https://api.congress.gov/v3/bill');
        url.searchParams.set('api_key', key);
        url.searchParams.set('format','json');
        url.searchParams.set('limit', perPage);
        const res = await fetch(url);
        if(!res.ok) throw new Error('Congress HTTP '+res.status);
        const data = await res.json();
        const bills = data.bills||[];
        els.cgCount.textContent = bills.length || '0';
        const items = bills.map(b=>{
          const title = b.title || `${b.type||''} ${b.number||''}`.trim();
          const introduced = b.introducedDate || b.latestAction?.actionDate;
          const meta = `${(b.originChamber||'').toUpperCase()} · ${introduced||''} ${introduced? '('+timeAgo(introduced)+')':''}`;
          const url = b.url || `https://www.congress.gov/bill/${b.congress||''}${b.type?'/'+b.type:''}${b.number?'/'+b.number:''}`;
          const pills = [b.type?.toUpperCase()||'BILL', b.congress?`${b.congress}th`:''];
          const id = b.number ? `CNG:${b.congress||''}-${b.type||''}-${b.number}` : url;
          return card({title, meta, url, pills, id, source:'CONGRESS'});
        }).join('');
        els.cgList.innerHTML = items || `<div class="card empty">No bills found.</div>`;
      }catch(err){
        els.cgList.innerHTML = `<div class="card danger">Congress.gov error (CORS or key?): ${err.message}</div>`;
        els.cgCount.textContent = 'error';
      }
    }

    async function loadAll(){
      const cfg = store.get();
      const results = await Promise.allSettled([
        loadFederalRegister(cfg.perPage||10),
        loadRegs(cfg.perPage||10, cfg.regsKey||''),
        loadWeather(),
        loadFRED(cfg.showFred!==false),
        loadCongress(cfg.perPage||10, cfg.cgKey||'')
      ]);
      if(results.some(r=>r.status==='fulfilled')){
        els.statusBadge.textContent = 'online';
        els.statusBadge.style.color = 'var(--ok)';
      }
      renderSaved();
    }
      renderSaved();
    }

    // Settings dialog logic
    els.openSettings.addEventListener('click', ()=>{
      const cfg = store.get();
      els.fieldState.value = cfg.state||'';
      els.fieldPerPage.value = cfg.perPage||10;
      els.fieldCgKey.value = cfg.cgKey||'';
      const regs = document.getElementById('regsKey');
      if(regs) regs.value = cfg.regsKey||'';
      const showFred = document.getElementById('showFred');
      if(showFred) showFred.checked = cfg.showFred!==false;
      els.fieldUseGeo.checked = !!cfg.useGeo;
      els.dlg.showModal();
    });
    els.closeSettings.addEventListener('click', ()=> els.dlg.close());

    els.form.addEventListener('submit', (e)=>{
      e.preventDefault();
      const state = els.fieldState.value.trim().toUpperCase();
      const perPage = Math.max(1, Math.min(50, Number(els.fieldPerPage.value)||10));
      const cgKey = els.fieldCgKey.value.trim();
      const regsEl = document.getElementById('regsKey');
      const regsKey = (regsEl?.value||'').trim();
      const showFredEl = document.getElementById('showFred');
      const showFred = !!(showFredEl?.checked);
      const useGeo = !!els.fieldUseGeo.checked;
      store.set({state, perPage, cgKey, regsKey, useGeo, showFred});
      els.dlg.close();
      loadAll();
    });
      const state = els.fieldState.value.trim().toUpperCase();
      const perPage = Math.max(1, Math.min(50, Number(els.fieldPerPage.value)||10));
      const cgKey = els.fieldCgKey.value.trim();
      const useGeo = !!els.fieldUseGeo.checked;
      store.set({state, perPage, cgKey, useGeo});
      els.dlg.close();
      loadAll();
    });
    els.resetBtn.addEventListener('click', ()=>{
      store.set({state:'PA', perPage:10, cgKey:'', regsKey:'', useGeo:false, showFred:true});
    });
    });

    els.refreshBtn.addEventListener('click', loadAll);

    // Diagnostics UI (points + forecast)
    els.diagnoseBtn.addEventListener('click', ()=>{ els.diag.showModal(); runDiagnostics(); });
    els.closeDiag.addEventListener('click', ()=> els.diag.close());

    async function runDiagnostics(){
      const cfg = store.get();
      els.diagOut.innerHTML = `<div class="card"><span class="spinner"></span> Testing connectivity…</div>`;
      // Use preferred coords (without asking again; may use capital)
      const loc = await getPreferredCoords();
      const tests = [
        { name: 'Federal Register', url: 'https://www.federalregister.gov/api/v1/documents.json?per_page=1&order=newest', init: {cache:'no-store'} },
        { name: 'NWS points', url: `https://api.weather.gov/points/${loc.lat},${loc.lon}`, init: {cache:'no-store'} },
        // forecast URL depends on points; probe a typical forecast path as a coarse check
        { name: 'Congress.gov (if key present)', url: cfg.cgKey ? `https://api.congress.gov/v3/bill?api_key=${encodeURIComponent(cfg.cgKey)}&format=json&limit=1` : null, init: {cache:'no-store'} }
      ];
      const results = await Promise.all(tests.map(async t=>{
        if(!t.url) return {name:t.name, ok:null, status:'(skipped — no key)', url:null};
        try{
          const r = await fetch(t.url, t.init);
          let msg = '';
          if(!r.ok){ try { const j = await r.json(); msg = j?.detail || j?.title || ''; } catch {} }
          return {name:t.name, ok:r.ok, status: msg ? `${r.status} – ${msg}` : r.status, url: t.url};
        }catch(e){ return {name:t.name, ok:false, status:e.message, url: t.url}; }
      }));
      els.diagOut.innerHTML = results.map(r=>{
        const badge = r.ok===true ? '<span class="badge ok">ok</span>' : (r.ok===null ? '<span class="badge">skipped</span>' : '<span class="badge danger">fail</span>');
        const urlLine = r.url ? `<div class="meta">URL: <a href="${r.url}" target="_blank" rel="noopener">${r.url}</a></div>` : '';
        return `<div class="card"><div class="row" style="justify-content:space-between"><strong>${r.name}</strong>${badge}</div><div class="meta">Status: ${r.status}</div>${urlLine}</div>`;
      }).join('');

      runSelfTests();
    }

    // Save/Unsave via event delegation
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('[data-save]');
      if(!btn) return;
      const item = { id: btn.dataset.id, title: btn.dataset.title, url: btn.dataset.url, source: btn.dataset.source, meta: btn.dataset.meta };
      saved.toggle(item);
      const nowSaved = saved.is(item.id);
      btn.dataset.saved = nowSaved ? '1' : '0';
      btn.textContent = nowSaved ? '★ Saved' : '☆ Save';
    });

    // --- Self tests (simple, non-blocking) ---
    function runSelfTests(){
      const tests = [];
      function t(name, fn){ try{ fn(); tests.push({name, pass:true}); } catch(e){ tests.push({name, pass:false, msg:e.message}); } }
      t('store.get() returns defaults', ()=>{ const cfg = store.get(); if(!cfg || typeof cfg !== 'object' || !('state' in cfg)) throw new Error('no defaults'); });
      t('saved.toggle() add/remove', ()=>{ const id = 'TEST:'+Date.now(); saved.toggle({id, title:'T', url:'#', source:'TEST', meta:''}); if(!saved.is(id)) throw new Error('did not add'); saved.toggle({id, title:'T', url:'#', source:'TEST', meta:''}); if(saved.is(id)) throw new Error('did not remove'); });
      t('card() renders save button', ()=>{ const html = card({title:'X', meta:'M', url:'#', pills:['P'], id:'ID', source:'FR'}); if(!html.includes('data-save="1"')) throw new Error('no save button'); });
      t('normalizeState()', ()=>{ if(normalizeState('pa') !== 'PA') throw new Error('lowercase not normalized'); if(normalizeState('US-NY') !== 'NY') throw new Error('US- prefix not handled'); if(normalizeState('XYZ') !== null) throw new Error('invalid should be null'); });
      t('getPreferredCoords() returns object', async ()=>{ const loc = await getPreferredCoords(); if(!loc || typeof loc.lat !== 'number') throw new Error('no coords'); });
      const out = tests.map(r=>`<div class="card ${r.pass?'':'danger'}"><strong>${r.pass?'✓':'✗'} ${r.name}</strong>${r.msg?`<div class="meta">${r.msg}</div>`:''}</div>`).join('');
      els.diagOut.insertAdjacentHTML('beforeend', `<div class="card"><strong>Self‑tests</strong><div class="grid" style="margin-top:8px">${out}</div></div>`);
      console.log('[GovFeeds self-tests]', tests);
    }

    // Initial load
    renderSaved();
    loadAll();
  </script>
</body>
</html>
